<p align="center">
<img src=../../README_images/go_logo.jpeg width="400">
</p>

<h1 align="center">Welcome to the October playground! Hands on with Ansible</h1>

[The Playground link](https://github.com/DevOpsPlayground/Hands-on-with-Ansible-Oct-2019.git)

# Intro

Hello and welcome to the March 2020 playground DIY.

The usage of cloud resources has grown considerably in recent years. Be it GCP, AWS or Azure, each has their own configurations and infrastructure setup. Rather than repeating the manual process of going through their various consoles and setting them up, Terraform provides an elegant solution as Infrastructure as code (IaC) and Ansible as a Configuration Management solution.

In this playground DIY you are going to be deploying recourses using Terraform and Ansible. 

Let's go!

# Check Before You Start!

We will be building the required infrastructure using Terraform so if you do not have this currently installed please [visit the Hashicorp website](https://learn.hashicorp.com/tutorials/terraform/install-cli) for how to do this.

**All infrastructure will require an AWS account so please make sure you have run through the installation process for AWS CLI and AWS config in the [root README.md file](../../README.md)**

## Important:

Before we get started there are a few things that are worth noting. We have set the defaults to a number of variables that can be changed within the `variables.tf` file if required:

* The current code will build two EC2 instances one for a workstation and a second for the ansible remote host.
* The workstation instance and remote host will run two containers. One with the project directory uploaded and wetty installed allowing SSH from the web. The other has VS Code installed providing a text editor to amend and save changed code. 
* If you prefer to use VIM then you can ! If not, you can use the VS Code IDE.
* If you have your own hosted zone set up in Route53 then you can use your own domain for each instance rather than the IPs. To do this uncomment lines `51-67` in `main.tf`, lines `25-31` in `outputs.tf` and lines `23-27` in `variables.tf`
* The default `region` is set to `eu-west-2`
* The default `deploy_count` is set to 1. Change this if you are running the playground for more than one user.
* The default `instance_type` is set to `t2.medium` as the t2.micro does not have enough resource to efficiently run the workstation. This on-demand pricing is $0.0464 per hour (£0.034 per hour) per instance. Should you leave this running for 1 month (720 hours), you would be charged $33.63 (£24.48) per instance. **make sure you delete the instance when finished with the playground!**

# Build Infrastructure

Make sure you are in the `March_2020` directory and run:

```
$ terraform init
```  
This will initialise a working directory containing our Terraform configuration files. This command is always safe to run multiple times, to bring the working directory up to date with changes in the configuration. You should see the following:

<p align="center">
<img src=../../README_images/tf_init.png width="600">
</p>

Then run:
```
$ terraform plan
```

This command is used to create an execution plan. Terraform performs a refresh, unless explicitly disabled, and then determines what actions are necessary to achieve the desired state specified in the configuration files.

This command is a convenient way to check whether the execution plan for a set of changes matches your expectations without making any changes to real resources or to the state. For example, terraform plan might be run before committing a change to version control, to create confidence that it will behave as expected. The plan will be fairly long but if all went well you should see the following in your terminal:

<p align="center">
<img src=../../README_images/march-20-plan.png width="600">
</p>

Finally you need to run:
```
$ terraform apply
```

This command is used to apply the changes required to reach the desired state of the configuration, or the pre-determined set of actions generated by a terraform plan execution plan. You will be prompted to enter a value to perform the action. Type `yes` as the value and hit enter.

Terraform will now build our required AWS infrastructure. This should complete after a minute or so showing the following:

<p align="center">
<img src=../../README_images/apply-march-20.png width="600">
</p>

> IMPORTANT! - make a note of the `WorkstationPassword` is auto-generated and will only be shown once. If lost you may need to build your instance again.

Once the apply has completed your EC2 instance will now be initializing and running the required script(s). Once the `instance state` have changed to `Running` they may take a further 4/5 minutes to install all the required dependencies. 

## Access

To access your instances check outputs in terminal after running `terraform apply`:

* Workstation instance - <workstation_ip>/wetty e.g. 318.130.177.57/wetty e.g. 18.130.177.57:3000/wetty
* IDE access - <workstation_ip>:8000 in browser e.g. 318.130.177.57:8000
* Workstation password - provided at the end of terraform apply


# Hands On 

In this playground we are going to be using Wetty an online terminal to run commands and an online VSCode IDE. 
## Pre Check 

First lets check if everything has installed correctly: Navigate to the wetty web terminal:

` <WORKSATION_IP>:8080 E.G. 192.168.0.1`

Once at the URL it should prompt you for a password: This is in the outputs: `WORKSTATION_PASSWORD = '<YOUR_PASSWORD>`

<img src=../../README_images/wetty_login.png width="600">

Once you're logged into your instance let us check if everything is installed.
- Copy or type the following commands

```bash
terraform --version
ansible --version
```
Running these commands are a check to see if these dependencies are successfully installed. 

<img src=../../README_images/versions.png width="600">

If for some reason these aren't installed on your instance run the following commands. when it prompts you for a password enter 
your `<WORKSTATION_PASSWORD>`. 

```bash
# INSTALL TERRAFORM 
curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
sudo apt-add-repository --yes "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
sudo apt-get install terraform -y
# INSTALL ANSIBLE 
sudo apt install software-properties-common
sudo apt-add-repository --yes --update ppa:ansible/ansible 
sudo apt-get install ansible -y 
```
Once this is done run the previous version commands again.
## Using Terraform

For ease of use you can use the web-ide for this playground access on `<PLAYGROUND_IP>:8000` or if you feel comfortable you can use VIM. 

- Open a new tab and access the IDE > (Keep the terminal open as we will need this for later )

You should see the following:

<img src=../../README_images/IDE.png width="600">



## Clean up

**Once you have finished playing around remember to delete the infrastructure to avoid any additional running charges as mentioned**

Make sure you are in the `March_2020` directory and run the following command:
```
$ terraform destroy
```
The command does exactly what it says on the tin. Infrastructure managed by Terraform will be destroyed. This will ask for confirmation before destroying, so please type `yes` when prompted.

**Again, you will continue to be charged by AWS if you do not run this final step**


