#!/bin/bash
##### INITILISE TERRAFORM FOR VALIDATION #####
# tput setaf 2; echo '#### INIT #####'


tput setaf 2; echo '##### Validation #####'
find ../ -name '*.tf' -exec  terraform validate  {} + 
if test $? -ne 0 
then 
    exit 1 
fi
tput setaf 2; echo "##### FORMATTING #####"
terraform fmt --recursive --check
if test $? -ne 0 
then 
    tput setaf 1 echo 'formatting error: please run "terraform fmt --recursive" then recommit.'
    exit 1 
fi
tput setaf 2; echo "##### LINTING #####"
find ../ -name '*.tf' -exec  tflint  {} /
if test $? -ne 0 
then 
    tput setaf 1; echo 'Linting Error: Please fix the above errors the recommit'
    exit 1 
fi
tput setaf 2; echo '##### ADDING DOCUMENTATION #####'
find . -type d -exec bash -c 'terraform-docs md "{}" > "{}"/README.md;' \;
if test $? -ne 0 
then 
    tput setaf 1; echo 'Documentation Error: Please make sure terraform-docs is installed'
    exit 1 
fi
tput setaf 2; echo '##### CHECKING FOR SECURITY ISSUES #####'
pwd 
find ../ -name '*.tf' -exec  tfsec --config-file tfsec.yml  {} + 
if test $? -ne 0 
then 
    tput setaf 1; echo 'security error: Please fix the above issues or add the security codes to tfsec.yml exclude'
    exit 0
fi